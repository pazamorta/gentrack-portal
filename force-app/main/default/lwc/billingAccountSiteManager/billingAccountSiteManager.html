<template>
  <div class="container slds-card">
    <div class="slds-grid slds-wrap" style="height: 100%">
      <!-- Sidebar: Billing Accounts -->
      <div
        class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 sidebar slds-border_right"
      >
        <div class="slds-p-around_medium slds-border_bottom">
          <h2
            class="slds-text-heading_small slds-truncate"
            title="Billing Accounts"
          >
            Billing Accounts
          </h2>
        </div>
        <div class="sidebar-content">
          <template if:true="{billingAccounts.data}">
            <ul class="slds-has-dividers_bottom-space">
              <template for:each="{billingAccounts.data}" for:item="acc">
                <li key="{acc.Id}" class="slds-item">
                  <div
                    class="{acc.itemClass}"
                    onclick="{handleAccountSelect}"
                    data-id="{acc.Id}"
                  >
                    <div class="slds-truncate" title="{acc.Name}">
                      {acc.Name}
                    </div>
                    <div class="slds-text-body_small slds-text-color_weak">
                      {acc.AccountNumber}
                    </div>
                  </div>
                </li>
              </template>
            </ul>
          </template>
          <template if:true="{billingAccounts.error}">
            <div class="slds-p-around_medium slds-text-color_error">
              Error loading accounts
            </div>
          </template>
        </div>
      </div>

      <!-- Main Content: Sites -->
      <div
        class="slds-col slds-size_1-of-1 slds-medium-size_9-of-12 main-content slds-p-around_medium"
      >
        <template if:true="{selectedAccount}">
          <!-- Header -->
          <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
            <div>
              <h2 class="slds-text-heading_medium">{selectedAccount.Name}</h2>
              <p class="slds-text-body_small">Manage linked sites</p>
            </div>
            <div>
              <template if:true="{hasChanges}">
                <lightning-button
                  label="Cancel"
                  title="Cancel"
                  onclick="{handleCancel}"
                  class="slds-m-right_x-small"
                >
                </lightning-button>
                <lightning-button
                  variant="brand"
                  label="Save Changes"
                  title="Save Changes"
                  onclick="{handleSave}"
                  is-loading="{isSaving}"
                >
                </lightning-button>
              </template>
            </div>
          </div>

          <!-- Tabs/Toggles -->
          <lightning-tabset
            active-tab-value="{currentTab}"
            onactive="{handleTabActive}"
          >
            <!-- Unassigned Sites Tab -->
            <lightning-tab
              label="Available Sites"
              value="unassigned"
              icon-name="utility:add"
            >
              <div class="slds-p-top_small">
                <div class="slds-text-color_weak slds-m-bottom_small">
                  Select sites to link to {selectedAccount.Name}
                </div>
                <div class="pill-container">
                  <template if:true="{unassignedSites.length}">
                    <template for:each="{unassignedSites}" for:item="site">
                      <button
                        key="{site.Id}"
                        class="{site.pillClass}"
                        onclick="{handleSiteToggle}"
                        data-id="{site.Id}"
                        title="{site.Name}"
                      >
                        {site.Name}
                      </button>
                    </template>
                  </template>
                  <template if:false="{unassignedSites.length}">
                    <div class="slds-illustration slds-illustration_small">
                      <div class="slds-text-longform">
                        <h3 class="slds-text-heading_small">
                          No available sites found.
                        </h3>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </lightning-tab>

            <!-- Linked Sites Tab -->
            <lightning-tab
              label="Linked Sites"
              value="linked"
              icon-name="utility:check"
            >
              <div class="slds-p-top_small">
                <div class="slds-text-color_weak slds-m-bottom_small">
                  Select sites to unlink from {selectedAccount.Name}
                </div>
                <div class="pill-container">
                  <template if:true="{linkedSites.length}">
                    <template for:each="{linkedSites}" for:item="site">
                      <button
                        key="{site.Id}"
                        class="{site.pillClass}"
                        onclick="{handleSiteToggle}"
                        data-id="{site.Id}"
                        title="{site.Name}"
                      >
                        {site.Name}
                        <lightning-icon
                          icon-name="utility:close"
                          size="xx-small"
                          class="slds-m-left_x-small pill-icon"
                        ></lightning-icon>
                      </button>
                    </template>
                  </template>
                  <template if:false="{linkedSites.length}">
                    <div class="slds-illustration slds-illustration_small">
                      <div class="slds-text-longform">
                        <h3 class="slds-text-heading_small">
                          No sites linked yet.
                        </h3>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </lightning-tab>
          </lightning-tabset>
        </template>

        <!-- Empty State -->
        <template if:false="{selectedAccount}">
          <div class="slds-align_absolute-center" style="height: 100%">
            <div class="slds-text-align_center slds-text-color_weak">
              <lightning-icon
                icon-name="standard:account"
                size="large"
                class="slds-m-bottom_medium"
              ></lightning-icon>
              <h3 class="slds-text-heading_medium">Select a Billing Account</h3>
              <p>Choose an account from the sidebar to manage sites.</p>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>
</template>
